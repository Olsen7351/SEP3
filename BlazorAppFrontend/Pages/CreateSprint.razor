@page "/project-hub/{ProjectIdAsString}/createSprint"
@inject ISprintBacklogService SprintService
@using Task = System.Threading.Tasks.Task
@using BlazorAppTEST.Services.Interface
@using ClassLibrary_SEP3

@attribute [Authorize]

@using ClassLibrary_SEP3.DataTransferObjects
@using Microsoft.AspNetCore.Mvc



<div class="container">
    <div class="card">
        <!-- Sprint Creation Form -->
        <h3>Sprint Creation</h3>
        <EditForm Model="newSprint" OnValidSubmit="CreateSprintBacklog">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="form-group">
                <label for="name">Project Id:</label>
                <InputText id="name" class="form-control" @bind-Value="newSprint.projectId"/>
                <ValidationMessage For="@(() => newSprint.projectId)" />
            </div>

            <div class="form-group">
                <label for="description">Title:</label>
                <InputTextArea id="description" class="form-control" @bind-Value="newSprint.Title"></InputTextArea>
            </div>

            <div class="form-group">
                <label for="startDate">Date:</label>
                <InputDate id="startDate" class="form-control" @bind-Value="newSprint.Timestamp"></InputDate>
                <ValidationMessage For="@(() => newSprint.Timestamp)" />
            </div>

            <button type="submit" class="btn btn-primary">Create</button>
        </EditForm>
    </div>
</div>
@if (createdSprint != null)
{
    <div class="container">
        <div class="card">
            <h3 style="color: lime;">Created Sprint Successfully!</h3>
            <p><strong>Project Id:</strong> @createdSprint.projectId</p>
            <p><strong>Title :</strong> @createdSprint.Title</p>
            <p><strong>Date:</strong> @createdSprint.Timestamp</p>
            
        </div>
    </div>
}
<!-- Sprint section -->
 <div class="sprint-backlogs">
     <p>Sprint Backlog Entries</p>
     @if (!SprintBacklogs.Any())
     {
         <div>@EmptyHelper</div>
     }
     else
     {
         @foreach (var backlog in SprintBacklogs)
         {
             <div class="sprint-backlog">
                 <p>Title: @backlog.Title</p>
                 <p>Created At: @backlog.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")</p>
                 <div>
                     <h4>Tasks</h4>
                     @if (backlog.Tasks.Any())
                     {
                         <ul>
                             @foreach (var task in backlog.Tasks)
                             {
                                 <li>@task.Description</li> 
                             }
                         </ul>
                     }
                     else
                     {
                         <p>No tasks available</p>
                     }
                 </div>
             </div>
         }
     }
     <button class="btn btn-primary" @onclick="CreateNewTask">Create New Task</button>
 </div>
 

@code
{
    [Parameter]
    public string ProjectIdAsString { get; set; }
    
    private CreateSprintBackLogRequest newSprint = new();
    private CreateSprintBackLogRequest createdSprint;
    private EditContext editContext;

    private List<SprintBacklog> SprintBacklogs = new List<SprintBacklog>();
    public string EmptyHelper { get; set; }
    
    protected async override Task OnInitializedAsync()
    {
        Console.WriteLine($"Received Project ID: {ProjectIdAsString}");
        newSprint = new CreateSprintBackLogRequest()
        {
            projectId = ProjectIdAsString,
            Timestamp = DateTime.Today
        };
        editContext = new EditContext(newSprint);
        await LoadSprintBacklogs();
    }

    private async Task CreateSprintBacklog()
    {
        Console.WriteLine("CreateSprintBacklog method called");
        if (!editContext.Validate())
        {
            return;
        }
        createdSprint = newSprint;
        var response = await SprintService.CreateSprintBacklogAsync(newSprint);
        Console.WriteLine($"Response Status: {response.ToString()}");
        newSprint = new CreateSprintBackLogRequest();
        editContext = new EditContext(newSprint);
        await LoadSprintBacklogs();
    }

    private async Task LoadSprintBacklogs()
    {
        var response = await SprintService.GetSprintBacklogsAsync(ProjectIdAsString);
        if (response is OkObjectResult result && result.Value is IEnumerable<SprintBacklog> backlogs)
        {
            SprintBacklogs = backlogs.ToList();
        }
        else
        {
            Console.WriteLine(response.GetType());

    }
    }

    private void CreateNewTask()
    {
        
    }
}
