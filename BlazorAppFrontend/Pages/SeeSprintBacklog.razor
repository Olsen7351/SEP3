@page "/project-hub/{ProjectIdAsString}/SeeSprintBacklog"
@using BlazorAppTEST.Services
@using BlazorAppTEST.Services.Interface
@using ClassLibrary_SEP3
@using ClassLibrary_SEP3.DataTransferObjects
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Mvc
@using Task = System.Threading.Tasks.Task
@using TaskStatus = System.Threading.Tasks.TaskStatus
@inject ISprintBacklogService SprintBacklogService
@inject NavigationManager NavigationManager
@attribute [Authorize]


<!-- Make new Sprint Backlog -->
<div class="container">
    <div class="card">
        <h3> SprintBacklog Creation</h3>
        <EditForm Model="sprintBacklog" OnValidSubmit="CreateSprintBacklog">
            <DataAnnotationsValidator />
            <ValidationSummary />
        
            <div class="form-group">
                <label for="title">Project Title:</label>
                <InputText id="title" class="form-control" @bind-Value="sprintBacklog.Title"/>
                <ValidationMessage For="@(() => sprintBacklog.Title)" />
            </div>
        
            <div class="form-group">
                <label for="startDate">Start Date:</label>
                <InputDate id="startDate" class="form-control" @bind-Value="sprintBacklog.Timestamp"></InputDate>
                <ValidationMessage For="@(() => sprintBacklog.Timestamp)" />
            </div>
            
            <button type="submit" class="btn btn-primary">Create</button>
        </EditForm>
    </div>
</div>
<!-- Conditional Rendering for Success Message -->
@if (isCreationSuccessful && createdSprintBacklog != null)
{
    <div class="container mt-4">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h3>Created SprintBacklog Successfully!</h3>
            </div>
            <div class="card-body">
                <p><strong>Project Id:</strong> @createdSprintBacklog.ProjectId</p>
                <p><strong>Sprint Backlog Id:</strong> @createdSprintBacklog.SprintBacklogId</p>
                <p><strong>Title:</strong> @createdSprintBacklog.Title</p>
                <p><strong>Start Date:</strong> @createdSprintBacklog.CreatedAt.ToShortDateString()</p>
            </div>
        </div>
    </div>
}
<!-- Sprint Backlogs -->
    <div>
        <h2>Sprint Backlogs for Project ID: @ProjectIdAsString</h2>
        @if (sprintBacklogs != null && sprintBacklogs.Any())
        {
            foreach (var sprintBacklog in sprintBacklogs)
            {
                <div class="card sprint-section">
                    <p>Sprint: @sprintBacklog.Title</p>
                    <p>Created At: @sprintBacklog.CreatedAt.ToString("yyyy-MM-dd")</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Responsible</th>
                                <th>Estimate Time</th>
                                <th>Actual Time Used</th>
                                <th>Created At</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var task in sprintBacklog.Tasks)
                            {
                                <tr>
                                    <td>@task.Title</td>
                                    <td>@task.Description</td>
                                    <td>@task.Status</td>
                                    <td>@task.Responsible</td>
                                    <td>@task.EstimateTimeInMinutes</td>
                                    <td>@task.ActualTimeUsedInMinutes</td>
                                    <td>@task.CreatedAt.ToString("yyyy-MM-dd")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    <button class="btn btn-primary" @onclick="() => NavigateToSprintDetails(sprintBacklog.SprintBacklogId)">View Sprint Details</button>
                </div>
            }
        }
        else
        {
            <p>No sprint backlogs available.</p>
        }
    </div>

    <!-- Add Task Section -->
    <div>
        <h2>Add a Task</h2>
        <EditForm Model="@newTask" OnValidSubmit="HandleValidSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div>
                <label for="title">Title:</label>
                <InputText id="title" @bind-Value="newTask.Title" />
            </div>

            <div>
                <label for="description">Description:</label>
                <InputTextArea id="description" @bind-Value="newTask.Description" />
            </div>

            <div>
                <label for="status">Status:</label>
                <InputSelect @bind-Value="newTask.Status">
                    @foreach (var status in Enum.GetValues(typeof(TaskStatus)))
                    {
                        <option value="@status">@status</option>
                    }
                </InputSelect>
            </div>

            <div>
                <label for="responsible">Responsible:</label>
                <InputText id="responsible" @bind-Value="newTask.Responsible" />
            </div>

            <div>
                <label for="estimateTime">Estimate Time (Minutes):</label>
                <InputNumber id="estimateTime" @bind-Value="newTask.EstimateTimeInMinutes" />
            </div>

            <div>
                <label for="actualTimeUsed">Actual Time Used (Minutes):</label>
                <InputNumber id="actualTimeUsed" @bind-Value="newTask.ActualTimeUsedInMinutes" />
            </div>

            <button type="submit">Add Task</button>
        </EditForm>
    </div>

   @code {
       
       
       [ParameterAttribute]
       public string ProjectIdAsString { get; set; }
       private string feedbackMessage = ""; 
       private bool isCreationSuccessful = false;
       private SprintBacklog createdSprintBacklog;
       
       private List<SprintBacklog> sprintBacklogs = new List<SprintBacklog>();
       private AddSprintTaskRequest newTask = new AddSprintTaskRequest();
       
       
       private CreateSprintBackLogRequest SprintBackLogRequest = new();
       private EditContext editContext;
       CreateSprintBackLogRequest sprintBacklog = new CreateSprintBackLogRequest();
       protected override void OnInitialized()
       {
           SprintBackLogRequest = new CreateSprintBackLogRequest
           {
                  Timestamp = DateTime.Today
           };
           editContext = new EditContext(SprintBackLogRequest);
       }
       
       protected override async Task OnParametersSetAsync()
       {
          
           await LoadSprintBacklogs();
       }
        private async Task CreateSprintBacklog()
          {
            if (!editContext.Validate())  // Check if the form is valid
            {
                return;
            }
          }
       private async Task HandleValidSubmit()
       {
           newTask.ProjectId = ProjectIdAsString;
           var result = await SprintBacklogService.AddTaskToSprintBacklogAsync(newTask);
           if (result is OkObjectResult) 
           {
               feedbackMessage = "Task added successfully!";
               newTask = new AddSprintTaskRequest(); 
               await LoadSprintBacklogs(); 
           }
           else if (result is NotFoundResult)
           {
               feedbackMessage = "Failed to add task. Sprint backlog not found.";
           }
           else
           {
               feedbackMessage = "Failed to add task due to an unknown error.";
           }
       }

       
       private async Task LoadSprintBacklogs()
       {
           try
           {
               var result = await SprintBacklogService.GetSprintBacklogsAsync(ProjectIdAsString);

               if (result is OkObjectResult okResult && okResult.Value is IEnumerable<SprintBacklog> backlogs)
               {
                   sprintBacklogs = backlogs.ToList();
               }
               else
               {
                   feedbackMessage = "Error: Unable to load sprint backlogs.";
               } 
           } catch  (Exception ex)
           {
               feedbackMessage = $"Error: Failed to load sprint backlogs. Details: {ex.Message}";
           }
       }
   
       private void NavigateToSprintDetails(string sprintId)
       {
           NavigationManager.NavigateTo($"/sprint-details/{sprintId}");
       }
   }

